<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>FreeFinder Wien - Gratis Deals & Rabatte</title>
    <meta name="description" content="Entdecke 200+ Gratis-Deals, Freebies & Rabatte in Wien! T√§glich aktualisiert.">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÅ</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #e8f4f8 0%, #d0e8f0 100%);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        .container { max-width: 800px; margin: 0 auto; padding: 16px; }
        header { text-align: center; padding: 20px 0 10px; }
        h1 { font-size: 28px; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .subtitle { color: #666; font-size: 14px; margin-top: 4px; }
        .stats { display: flex; justify-content: center; gap: 20px; margin-top: 12px; font-size: 13px; color: #888; }
        .search-box { background: white; border-radius: 14px; padding: 14px 18px; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin: 16px 0; position: relative; }
        .search-box input { flex: 1; border: none; outline: none; font-size: 16px; background: transparent; }
        .search-box svg { width: 20px; height: 20px; color: #999; }
        .search-box .clear-btn { background: #e5e7eb; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; font-size: 12px; color: #666; }
        .search-box .clear-btn.show { display: flex; }
        
        /* Smart Search Dropdown */
        .search-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); margin-top: 8px; display: none; z-index: 200; overflow: hidden; max-height: 400px; overflow-y: auto; }
        .search-dropdown.show { display: block; animation: slideDown 0.2s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .search-section { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; }
        .search-section:last-child { border-bottom: none; }
        .search-section-title { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .search-item { padding: 10px 12px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.15s; }
        .search-item:hover { background: #f1f5f9; }
        .search-item-icon { font-size: 16px; }
        .search-item-text { flex: 1; font-size: 14px; }
        .search-item-meta { font-size: 12px; color: #94a3b8; }
        .search-item-delete { background: none; border: none; color: #94a3b8; cursor: pointer; padding: 4px; border-radius: 4px; }
        .search-item-delete:hover { background: #fee2e2; color: #ef4444; }
        .search-tag { display: inline-flex; align-items: center; gap: 4px; background: #f1f5f9; padding: 6px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; transition: all 0.15s; margin: 4px; }
        .search-tag:hover { background: #e2e8f0; }
        .search-tag.trending { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .autocomplete-highlight { background: #fef08a; border-radius: 2px; }
        .filters { background: white; border-radius: 20px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 16px; position: sticky; top: 0; z-index: 100; transition: all 0.3s ease; }
        .filters.scrolled { border-radius: 0 0 20px 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); margin-left: -16px; margin-right: -16px; padding-left: 20px; padding-right: 20px; }
        .filter-row { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0; scrollbar-width: none; -ms-overflow-style: none; }
        .filter-row::-webkit-scrollbar { display: none; }
        .filter-btn { padding: 10px 16px; border-radius: 25px; border: none; background: #f1f5f9; color: #334155; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .filter-btn:hover { background: #e2e8f0; }
        .filter-btn.active { background: #3b82f6; color: white; }
        .filter-btn.active-dark { background: #1e293b; color: white; }
        .filter-divider { height: 1px; background: #e5e7eb; margin: 12px 0; }
        .filter-count { background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .filter-btn.active .filter-count { background: rgba(255,255,255,0.25); }
        .deals { display: flex; flex-direction: column; gap: 14px; }
        .deal-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 2px solid transparent; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-decoration: none; color: inherit; display: block; }
        .deal-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .deal-card.hot { border-color: #ef4444; }
        .deal-card.gratis { border-color: #10b981; }
        .deal-card.rabatt { border-color: #f59e0b; }
        .deal-card.code { border-color: #8b5cf6; }
        .deal-header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
        .deal-logo { width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }
        .deal-meta { flex: 1; min-width: 0; }
        .deal-brand { font-weight: 600; font-size: 14px; }
        .deal-source { font-size: 12px; color: #888; }
        .deal-badges { display: flex; gap: 6px; flex-wrap: wrap; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; color: white; }
        .badge-hot { background: #ef4444; }
        .badge-new { background: #06b6d4; }
        .badge-gratis { background: #10b981; }
        .badge-rabatt { background: #f59e0b; }
        .badge-testabo { background: #3b82f6; }
        .badge-code { background: #8b5cf6; }
        .deal-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; line-height: 1.3; }
        .deal-desc { font-size: 14px; color: #666; line-height: 1.4; margin-bottom: 12px; }
        .deal-footer { display: flex; justify-content: space-between; align-items: center; }
        .deal-expires { font-size: 12px; color: #888; display: flex; align-items: center; gap: 4px; }
        .deal-cta { color: #3b82f6; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        .vote-section { display: flex; align-items: center; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f1f5f9; }
        .vote-btn { background: #f1f5f9; border: none; border-radius: 8px; padding: 6px 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 14px; transition: all 0.2s; }
        .vote-btn:hover { background: #e2e8f0; }
        .vote-btn.upvoted { background: #dcfce7; color: #16a34a; }
        .vote-btn.downvoted { background: #fee2e2; color: #dc2626; }
        .vote-count { font-weight: 600; font-size: 14px; min-width: 30px; text-align: center; }
        .vote-count.positive { color: #16a34a; }
        .vote-count.negative { color: #dc2626; }
        .share-btn { background: #25D366; border: none; border-radius: 8px; padding: 6px 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 13px; color: white; font-weight: 600; transition: all 0.2s; margin-left: 8px; }
        .share-btn:hover { background: #128C7E; }
        .share-btn svg { width: 16px; height: 16px; fill: white; }
        
        /* Gamification */
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px 24px; border-radius: 50px; font-weight: 600; font-size: 14px; z-index: 1000; opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4); display: flex; align-items: center; gap: 10px; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast-emoji { font-size: 24px; animation: bounce 0.6s ease; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }
        @keyframes float-up { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.5); } }
        .vote-btn.animate-up { animation: pop 0.3s ease; }
        .vote-btn.animate-down { animation: shake 0.3s ease; }
        .floating-emoji { position: fixed; pointer-events: none; font-size: 28px; z-index: 1001; animation: float-up 1s ease-out forwards; }
        .streak-badge { background: linear-gradient(135deg, #f59e0b, #ef4444); padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 6px; }
        
        /* Hook Banner */
        .hook-banner { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); border-radius: 16px; padding: 16px; margin-bottom: 16px; color: white; position: relative; overflow: hidden; }
        .hook-banner::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%); animation: shimmer 3s infinite; }
        @keyframes shimmer { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(180deg); } }
        .hook-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; position: relative; }
        .hook-subtitle { font-size: 13px; opacity: 0.9; position: relative; }
        .hook-stats { display: flex; gap: 12px; margin-top: 12px; position: relative; }
        .hook-stat { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 8px 14px; border-radius: 12px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .hook-stat.urgent { background: rgba(239, 68, 68, 0.8); animation: pulse-urgent 2s infinite; }
        @keyframes pulse-urgent { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .hook-close { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; }
        .badge-expires { background: #ef4444; animation: pulse-urgent 2s infinite; }
        .deal-card.expiring { border-color: #ef4444; background: linear-gradient(135deg, white 0%, #fef2f2 100%); }
        .expires-warning { color: #ef4444; font-weight: 600; }
        .code-display { background: #faf5ff; border: 2px dashed #8b5cf6; border-radius: 8px; padding: 8px 12px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center; }
        .code-text { font-family: monospace; font-weight: 700; color: #7c3aed; font-size: 14px; }
        .code-copy { background: #8b5cf6; color: white; border: none; border-radius: 6px; padding: 4px 10px; font-size: 12px; cursor: pointer; }
        .code-copy:hover { background: #7c3aed; }
        .empty { text-align: center; padding: 60px 20px; color: #666; }
        .empty-icon { font-size: 48px; margin-bottom: 12px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .install-banner { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px 16px; border-radius: 14px; display: none; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .install-banner button { background: white; color: #667eea; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        @media (max-width: 480px) { h1 { font-size: 24px; } .filter-btn { padding: 8px 12px; font-size: 13px; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÅ FreeFinder Wien</h1>
            <p class="subtitle">T√§glich aktualisierte Gratis-Deals & Rabatte</p>
            <div class="stats">
                <span id="dealCount">0 Deals</span>
                <span id="lastUpdate">L√§dt...</span>
            </div>
        </header>
        <div class="install-banner" id="installBanner">
            <span>üì± Als App installieren</span>
            <button onclick="installApp()">Installieren</button>
        </div>
        
        <div class="hook-banner" id="hookBanner">
            <button class="hook-close" onclick="closeHook()">‚úï</button>
            <div class="hook-title">
                <span id="hookEmoji">üî•</span>
                <span id="hookTitle">Heute neu eingetroffen!</span>
            </div>
            <div class="hook-subtitle" id="hookSubtitle">Schau dir die neuesten Gratis-Deals an, bevor sie weg sind!</div>
            <div class="hook-stats">
                <div class="hook-stat" id="hookNew">‚ú® <span id="newToday">0</span> neue Deals</div>
                <div class="hook-stat" id="hookGratis">üéÅ <span id="gratisCount">0</span> Gratis</div>
                <div class="hook-stat urgent" id="hookUrgent">‚è∞ <span id="expiringCount">0</span> laufen bald ab!</div>
            </div>
        </div>
        <div class="search-box" id="searchBox">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input type="text" id="searchInput" placeholder="Suche z.B. Kaffee, IKEA, gratis..." autocomplete="off">
            <button class="clear-btn" id="clearBtn" onclick="clearSearch(event)">‚úï</button>
            
            <div class="search-dropdown" id="searchDropdown">
                <div class="search-section" id="recentSection">
                    <div class="search-section-title">üïí Letzte Suchen</div>
                    <div id="recentSearches"></div>
                </div>
                <div class="search-section">
                    <div class="search-section-title">üî• Beliebte Suchen</div>
                    <div id="popularSearches">
                        <span class="search-tag trending" onclick="searchFor('gratis kaffee')">‚òï Gratis Kaffee</span>
                        <span class="search-tag trending" onclick="searchFor('fitness')">üí™ Fitness</span>
                        <span class="search-tag" onclick="searchFor('mcdonalds')">üçü McDonald's</span>
                        <span class="search-tag" onclick="searchFor('ikea')">ü™ë IKEA</span>
                        <span class="search-tag" onclick="searchFor('flug')">‚úàÔ∏è Fl√ºge</span>
                        <span class="search-tag" onclick="searchFor('rabattcode')">üè∑Ô∏è Rabattcode</span>
                        <span class="search-tag" onclick="searchFor('essen')">üçï Essen</span>
                        <span class="search-tag" onclick="searchFor('streaming')">üì∫ Streaming</span>
                    </div>
                </div>
                <div class="search-section" id="autocompleteSection" style="display:none;">
                    <div class="search-section-title">üí° Vorschl√§ge</div>
                    <div id="autocompleteResults"></div>
                </div>
            </div>
        </div>
        <div class="filters">
            <div class="filter-row" id="typeFilters">
                <button class="filter-btn active" data-filter="alle">üéØ Alle <span class="filter-count" id="countAll">0</span></button>
                <button class="filter-btn" data-filter="gratis">üéÅ Gratis <span class="filter-count" id="countGratis">0</span></button>
                <button class="filter-btn" data-filter="rabatt">üí∞ Rabatt <span class="filter-count" id="countRabatt">0</span></button>
                <button class="filter-btn" data-filter="codes">üè∑Ô∏è Codes <span class="filter-count" id="countCodes">0</span></button>
                <button class="filter-btn" data-filter="neu">‚ú® Neu <span class="filter-count" id="countNeu">0</span></button>
            </div>
            <div class="filter-divider"></div>
            <div class="filter-row" id="categoryFilters">
                <button class="filter-btn active-dark" data-category="alle">üéØ Alle</button>
                <button class="filter-btn" data-category="essen">üçî Essen</button>
                <button class="filter-btn" data-category="kaffee">‚òï Kaffee</button>
                <button class="filter-btn" data-category="supermarkt">üõí Supermarkt</button>
                <button class="filter-btn" data-category="beauty">üíá Beauty</button>
                <button class="filter-btn" data-category="fitness">üí™ Fitness</button>
                <button class="filter-btn" data-category="reisen">‚úàÔ∏è Reisen</button>
                <button class="filter-btn" data-category="codes">üè∑Ô∏è Rabattcodes</button>
                <button class="filter-btn" data-category="shopping">üõçÔ∏è Shopping</button>
                <button class="filter-btn" data-category="technik">üì± Technik</button>
                <button class="filter-btn" data-category="streaming">üì∫ Streaming</button>
                <button class="filter-btn" data-category="mobilit√§t">üöå Mobilit√§t</button>
                <button class="filter-btn" data-category="wien">üèõÔ∏è Wien</button>
                <button class="filter-btn" data-category="finanzen">üí≥ Finanzen</button>
                <button class="filter-btn" data-category="mode">üëï Mode</button>
            </div>
        </div>
        <div class="deals" id="dealsList"><div class="loading">‚è≥ Lade Deals...</div></div>
        <div class="toast" id="toast"><span class="toast-emoji" id="toastEmoji">üëç</span><span id="toastText">Danke f√ºr dein Feedback!</span></div>
    </div>
    <script>
        let allDeals = [], currentFilter = 'alle', currentCategory = 'alle', searchQuery = '';
        let votes = JSON.parse(localStorage.getItem('dealVotes') || '{}'), deferredPrompt;
        const hookClosed = localStorage.getItem('hookClosed');
        const lastVisit = localStorage.getItem('lastVisit') || 0;
        
        function closeHook() {
            document.getElementById('hookBanner').style.display = 'none';
            localStorage.setItem('hookClosed', Date.now());
        }
        
        function updateHookBanner() {
            const banner = document.getElementById('hookBanner');
            const now = new Date();
            const hour = now.getHours();
            
            // Verstecke wenn heute schon geschlossen
            const closed = localStorage.getItem('hookClosed');
            if (closed && (Date.now() - parseInt(closed)) < 12 * 60 * 60 * 1000) {
                banner.style.display = 'none';
                return;
            }
            
            // Z√§hle Deals
            const newDeals = allDeals.filter(d => d.isNew).length;
            const gratisDeals = allDeals.filter(d => d.type === 'gratis' || d.type === 'testabo').length;
            const expiringDeals = allDeals.filter(d => {
                const exp = (d.expires || '').toLowerCase();
                return exp.includes('heute') || exp.includes('begrenzt') || exp.includes('flash') || exp.includes('limited') || exp.includes('bald');
            }).length;
            
            document.getElementById('newToday').textContent = newDeals;
            document.getElementById('gratisCount').textContent = gratisDeals;
            document.getElementById('expiringCount').textContent = expiringDeals || 3;
            
            // Verstecke "l√§uft ab" wenn keine
            if (expiringDeals === 0) {
                document.getElementById('hookUrgent').style.display = 'none';
            }
            
            // Dynamische Messages basierend auf Tageszeit & Kontext
            const hooks = [];
            
            if (hour >= 6 && hour < 11) {
                hooks.push({ emoji: '‚òÄÔ∏è', title: 'Guten Morgen! Neue Deals warten!', sub: 'Starte den Tag mit den besten Gratis-Angeboten in Wien!' });
                hooks.push({ emoji: '‚òï', title: 'Fr√ºhst√ºcks-Deals gef√§llig?', sub: 'Gratis Kaffee, Snacks und mehr - perfekt f√ºr den Morgen!' });
            } else if (hour >= 11 && hour < 14) {
                hooks.push({ emoji: 'üçï', title: 'Mittagspause? Zeit f√ºr Deals!', sub: 'Die besten Gratis-Essen Angebote f√ºr die Pause!' });
                hooks.push({ emoji: 'üî•', title: 'Lunch-Time Deals!', sub: 'Schnapp dir ein Gratis-Mittagessen - nur heute!' });
            } else if (hour >= 14 && hour < 18) {
                hooks.push({ emoji: '‚ö°', title: 'Nachmittags-Flash-Deals!', sub: 'Diese Angebote sind nur noch kurze Zeit verf√ºgbar!' });
                hooks.push({ emoji: 'üõçÔ∏è', title: 'Shopping-Time!', sub: 'Die besten Rabattcodes und Gratis-Aktionen warten!' });
            } else if (hour >= 18 && hour < 22) {
                hooks.push({ emoji: 'üåô', title: 'Abend-Specials eingetroffen!', sub: 'Neue Deals f√ºr heute Abend - nicht verpassen!' });
                hooks.push({ emoji: 'üçî', title: 'Hunger am Abend?', sub: 'Entdecke Gratis-Essen und Restaurant-Deals!' });
            } else {
                hooks.push({ emoji: 'ü¶â', title: 'Nacht-Eulen aufgepasst!', sub: 'Exklusive Deals nur f√ºr dich - w√§hrend andere schlafen!' });
                hooks.push({ emoji: '‚≠ê', title: 'Geheime Midnight-Deals!', sub: 'Die besten Schn√§ppchen der Nacht!' });
            }
            
            // Spezielle Hooks
            if (newDeals >= 5) {
                hooks.push({ emoji: 'üÜï', title: `${newDeals} neue Deals heute!`, sub: 'Frisch eingetroffen - als Erster zuschlagen!' });
            }
            if (gratisDeals >= 20) {
                hooks.push({ emoji: 'üéÅ', title: `${gratisDeals}x komplett GRATIS!`, sub: 'So viele Freebies gab es noch nie - schnell sein!' });
            }
            
            // W√§hle zuf√§lligen Hook
            const hook = hooks[Math.floor(Math.random() * hooks.length)];
            document.getElementById('hookEmoji').textContent = hook.emoji;
            document.getElementById('hookTitle').textContent = hook.title;
            document.getElementById('hookSubtitle').textContent = hook.sub;
            
            banner.style.display = 'block';
            localStorage.setItem('lastVisit', Date.now());
        }

        async function loadDeals() {
            try {
                const response = await fetch('deals.json?t=' + Date.now());
                const data = await response.json();
                allDeals = data.deals;
                allDeals.forEach(deal => { deal.votes = votes[deal.id] || 0; });
                updateCounts();
                document.getElementById('lastUpdate').textContent = 'Aktualisiert: ' + new Date(data.lastUpdated).toLocaleString('de-AT', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
                renderDeals();
                updateHookBanner();
            } catch (e) { document.getElementById('dealsList').innerHTML = '<div class="empty"><div class="empty-icon">üòï</div><p>Fehler beim Laden</p></div>'; }
        }

        function updateCounts() {
            document.getElementById('countAll').textContent = allDeals.length;
            document.getElementById('countGratis').textContent = allDeals.filter(d => d.type === 'gratis' || d.type === 'testabo').length;
            document.getElementById('countRabatt').textContent = allDeals.filter(d => d.type === 'rabatt').length;
            document.getElementById('countCodes').textContent = allDeals.filter(d => d.category === 'codes' || d.code).length;
            document.getElementById('countNeu').textContent = allDeals.filter(d => d.isNew).length;
            document.getElementById('dealCount').textContent = allDeals.length + ' Deals';
        }

        function filterDeals() {
            let f = [...allDeals];
            if (currentFilter === 'gratis') f = f.filter(d => d.type === 'gratis' || d.type === 'testabo');
            else if (currentFilter === 'rabatt') f = f.filter(d => d.type === 'rabatt');
            else if (currentFilter === 'codes') f = f.filter(d => d.category === 'codes' || d.code);
            else if (currentFilter === 'neu') f = f.filter(d => d.isNew);
            if (currentCategory !== 'alle') f = f.filter(d => d.category === currentCategory);
            if (searchQuery) { const q = searchQuery.toLowerCase(); f = f.filter(d => d.title.toLowerCase().includes(q) || d.description.toLowerCase().includes(q) || d.brand.toLowerCase().includes(q) || (d.code && d.code.toLowerCase().includes(q))); }
            f.sort((a, b) => { if ((b.votes||0) !== (a.votes||0)) return (b.votes||0) - (a.votes||0); if ((a.priority||99) !== (b.priority||99)) return (a.priority||99) - (b.priority||99); return b.hot ? 1 : -1; });
            return f;
        }

        let voteStreak = parseInt(localStorage.getItem('voteStreak') || '0');
        
        function showToast(emoji, text) {
            const toast = document.getElementById('toast');
            const toastEmoji = document.getElementById('toastEmoji');
            const toastText = document.getElementById('toastText');
            toastEmoji.textContent = emoji;
            toastText.textContent = text;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
        
        function createFloatingEmoji(emoji, x, y) {
            const el = document.createElement('div');
            el.className = 'floating-emoji';
            el.textContent = emoji;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }
        
        function vote(id, dir, e) { 
            e.preventDefault(); 
            e.stopPropagation(); 
            const d = allDeals.find(x => x.id === id); 
            if (!d) return; 
            const c = votes[id] || 0;
            const newVote = dir === 'up' ? (c === 1 ? 0 : 1) : (c === -1 ? 0 : -1);
            votes[id] = newVote;
            d.votes = newVote; 
            localStorage.setItem('dealVotes', JSON.stringify(votes));
            
            // Animation auf Button
            const btn = e.target;
            btn.classList.remove('animate-up', 'animate-down');
            void btn.offsetWidth; // Reflow
            btn.classList.add(dir === 'up' ? 'animate-up' : 'animate-down');
            
            // Floating Emoji
            const rect = btn.getBoundingClientRect();
            const emojis = dir === 'up' ? ['üëç', 'üéâ', '‚≠ê', 'üíö', 'üî•'] : ['üëé', 'üòï', 'üìù'];
            createFloatingEmoji(emojis[Math.floor(Math.random() * emojis.length)], rect.left + 20, rect.top);
            
            // Toast Messages
            if (newVote !== 0) {
                voteStreak++;
                localStorage.setItem('voteStreak', voteStreak);
                
                const messages = dir === 'up' 
                    ? [
                        { emoji: 'üôè', text: 'Danke f√ºr dein Feedback!' },
                        { emoji: '‚≠ê', text: 'Super, das hilft anderen!' },
                        { emoji: 'üéØ', text: 'Deal gemerkt!' },
                        { emoji: 'üí™', text: 'Deine Stimme z√§hlt!' },
                        { emoji: 'üî•', text: 'Hot Deal markiert!' }
                    ]
                    : [
                        { emoji: 'üìù', text: 'Feedback notiert!' },
                        { emoji: 'üëÄ', text: 'Wir pr√ºfen das!' },
                        { emoji: 'üôè', text: 'Danke f√ºr die Ehrlichkeit!' }
                    ];
                
                // Streak Bonuses
                if (voteStreak === 5) {
                    showToast('üî•', '5er Streak! Du bist on fire!');
                } else if (voteStreak === 10) {
                    showToast('‚≠ê', '10 Votes! Deal-Experte!');
                } else if (voteStreak === 25) {
                    showToast('üèÜ', '25 Votes! Du bist ein Held!');
                } else {
                    const msg = messages[Math.floor(Math.random() * messages.length)];
                    showToast(msg.emoji, msg.text);
                }
            }
            
            renderDeals(); 
        }

        function copyCode(code, e) { e.preventDefault(); e.stopPropagation(); navigator.clipboard.writeText(code); e.target.textContent = '‚úì Kopiert!'; setTimeout(() => e.target.textContent = 'Kopieren', 1500); }

        function shareDeal(title, url, e) { 
            e.preventDefault(); 
            e.stopPropagation(); 
            const text = `üéÅ Gratis-Deal Tipp: ${title}\n\nüëâ ${url}\n\nüì± Mehr Deals auf FreeFinder Wien!`;
            const waUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(waUrl, '_blank');
        }

        function renderDeals() {
            const f = filterDeals(), c = document.getElementById('dealsList');
            if (!f.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">üòï</div><p>Keine Deals gefunden</p></div>'; return; }
            c.innerHTML = f.map(d => {
                const v = votes[d.id] || 0, vc = v > 0 ? 'positive' : v < 0 ? 'negative' : '', up = v === 1 ? 'upvoted' : '', dn = v === -1 ? 'downvoted' : '';
                const exp = (d.expires || '').toLowerCase();
                const isExpiring = exp.includes('heute') || exp.includes('begrenzt') || exp.includes('flash') || exp.includes('limited') || exp.includes('bald');
                let cc = 'deal-card'; if (isExpiring) cc += ' expiring'; else if (d.hot) cc += ' hot'; else if (d.type === 'gratis') cc += ' gratis'; else if (d.category === 'codes' || d.code) cc += ' code'; else if (d.type === 'rabatt') cc += ' rabatt';
                let code = ''; if (d.code && !['In App','Per Email','Auto-aktiviert'].includes(d.code)) code = `<div class="code-display"><span class="code-text">${d.code}</span><button class="code-copy" onclick="copyCode('${d.code}',event)">Kopieren</button></div>`;
                const expiringBadge = isExpiring ? '<span class="badge badge-expires">‚è∞ BALD WEG</span>' : '';
                return `<a href="${d.url}" target="_blank" rel="noopener" class="${cc}"><div class="deal-header"><div class="deal-logo">${d.logo||'üéÅ'}</div><div class="deal-meta"><div class="deal-brand">${d.brand}</div><div class="deal-source">${d.source}</div></div><div class="deal-badges">${expiringBadge}${d.hot?'<span class="badge badge-hot">üî• HOT</span>':''}${d.isNew?'<span class="badge badge-new">‚ú® NEU</span>':''}${d.code?'<span class="badge badge-code">CODE</span>':''}<span class="badge badge-${d.type}">${d.type.toUpperCase()}</span></div></div><div class="deal-title">${d.title}</div><div class="deal-desc">${d.description}</div>${code}<div class="deal-footer"><div class="deal-expires ${isExpiring?'expires-warning':''}">üïí ${d.expires||'Unbegrenzt'}</div><div class="deal-cta">Zum Deal ‚Üí</div></div><div class="vote-section" onclick="event.preventDefault()"><button class="vote-btn ${up}" onclick="vote('${d.id}','up',event)">üëç</button><span class="vote-count ${vc}">${v>0?'+':''}${v}</span><button class="vote-btn ${dn}" onclick="vote('${d.id}','down',event)">üëé</button><button class="share-btn" onclick="shareDeal('${d.title.replace(/'/g, "\\'")}','${d.url}',event)"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>Teilen</button><span style="margin-left:auto;font-size:12px;color:#888;">${d.distance||''}</span></div></a>`;
            }).join('');
        }

        // Smart Search System
        let recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
        const searchInput = document.getElementById('searchInput');
        const searchDropdown = document.getElementById('searchDropdown');
        const clearBtn = document.getElementById('clearBtn');
        const autocompleteSection = document.getElementById('autocompleteSection');
        const autocompleteResults = document.getElementById('autocompleteResults');
        const recentSection = document.getElementById('recentSection');
        
        function renderRecentSearches() {
            const container = document.getElementById('recentSearches');
            if (recentSearches.length === 0) {
                recentSection.style.display = 'none';
                return;
            }
            recentSection.style.display = 'block';
            container.innerHTML = recentSearches.slice(0, 5).map((s, i) => `
                <div class="search-item" onclick="searchFor('${s}')">
                    <span class="search-item-icon">üïí</span>
                    <span class="search-item-text">${s}</span>
                    <button class="search-item-delete" onclick="deleteRecent(${i}, event)">‚úï</button>
                </div>
            `).join('');
        }
        
        function deleteRecent(index, e) {
            e.stopPropagation();
            recentSearches.splice(index, 1);
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            renderRecentSearches();
        }
        
        function saveSearch(query) {
            if (!query || query.length < 2) return;
            recentSearches = recentSearches.filter(s => s.toLowerCase() !== query.toLowerCase());
            recentSearches.unshift(query);
            recentSearches = recentSearches.slice(0, 10);
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
        }
        
        function searchFor(query) {
            searchInput.value = query;
            searchQuery = query;
            saveSearch(query);
            searchDropdown.classList.remove('show');
            clearBtn.classList.add('show');
            renderDeals();
        }
        
        function clearSearch(e) {
            if (e) e.stopPropagation();
            searchInput.value = '';
            searchQuery = '';
            clearBtn.classList.remove('show');
            renderDeals();
        }
        
        function getAutocomplete(query) {
            if (!query || query.length < 2) return [];
            const q = query.toLowerCase();
            const results = [];
            const seen = new Set();
            
            // Match brands
            allDeals.forEach(d => {
                if (d.brand.toLowerCase().includes(q) && !seen.has(d.brand)) {
                    seen.add(d.brand);
                    results.push({ type: 'brand', text: d.brand, icon: d.logo || 'üè∑Ô∏è', count: allDeals.filter(x => x.brand === d.brand).length });
                }
            });
            
            // Match categories
            const categories = { essen: 'üçî', kaffee: '‚òï', supermarkt: 'üõí', beauty: 'üíá', fitness: 'üí™', reisen: '‚úàÔ∏è', codes: 'üè∑Ô∏è', shopping: 'üõçÔ∏è', technik: 'üì±', streaming: 'üì∫', mobilit√§t: 'üöå', wien: 'üèõÔ∏è', finanzen: 'üí≥', mode: 'üëï' };
            Object.keys(categories).forEach(cat => {
                if (cat.includes(q) && !seen.has(cat)) {
                    seen.add(cat);
                    results.push({ type: 'category', text: cat.charAt(0).toUpperCase() + cat.slice(1), icon: categories[cat], count: allDeals.filter(x => x.category === cat).length });
                }
            });
            
            // Match deal titles
            allDeals.forEach(d => {
                if (d.title.toLowerCase().includes(q) && !seen.has(d.title)) {
                    seen.add(d.title);
                    results.push({ type: 'deal', text: d.title, icon: d.logo || 'üéÅ', meta: d.brand });
                }
            });
            
            return results.slice(0, 8);
        }
        
        function renderAutocomplete(query) {
            const results = getAutocomplete(query);
            if (results.length === 0) {
                autocompleteSection.style.display = 'none';
                return;
            }
            
            autocompleteSection.style.display = 'block';
            autocompleteResults.innerHTML = results.map(r => {
                const highlighted = r.text.replace(new RegExp(`(${query})`, 'gi'), '<span class="autocomplete-highlight">$1</span>');
                const meta = r.count ? `${r.count} Deals` : (r.meta || '');
                return `
                    <div class="search-item" onclick="searchFor('${r.text.replace(/'/g, "\\'")}')">
                        <span class="search-item-icon">${r.icon}</span>
                        <span class="search-item-text">${highlighted}</span>
                        <span class="search-item-meta">${meta}</span>
                    </div>
                `;
            }).join('');
        }
        
        searchInput.addEventListener('focus', () => {
            renderRecentSearches();
            searchDropdown.classList.add('show');
        });
        
        searchInput.addEventListener('input', e => {
            const query = e.target.value;
            searchQuery = query;
            
            if (query.length > 0) {
                clearBtn.classList.add('show');
                renderAutocomplete(query);
            } else {
                clearBtn.classList.remove('show');
                autocompleteSection.style.display = 'none';
            }
            
            renderDeals();
        });
        
        searchInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && searchQuery) {
                saveSearch(searchQuery);
                searchDropdown.classList.remove('show');
            }
            if (e.key === 'Escape') {
                searchDropdown.classList.remove('show');
                searchInput.blur();
            }
        });
        
        document.addEventListener('click', e => {
            if (!document.getElementById('searchBox').contains(e.target)) {
                searchDropdown.classList.remove('show');
            }
        });

        document.getElementById('typeFilters').addEventListener('click', e => { if (e.target.classList.contains('filter-btn')) { document.querySelectorAll('#typeFilters .filter-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); currentFilter = e.target.dataset.filter; renderDeals(); }});
        document.getElementById('categoryFilters').addEventListener('click', e => { if (e.target.classList.contains('filter-btn')) { document.querySelectorAll('#categoryFilters .filter-btn').forEach(b => b.classList.remove('active-dark')); e.target.classList.add('active-dark'); currentCategory = e.target.dataset.category; renderDeals(); }});
        window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBanner').style.display = 'flex'; });
        function installApp() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then(() => { deferredPrompt = null; document.getElementById('installBanner').style.display = 'none'; }); }}
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        
        // Sticky Filter Effect
        const filters = document.querySelector('.filters');
        let lastScroll = 0;
        window.addEventListener('scroll', () => {
            const scrollY = window.scrollY;
            if (scrollY > 100) {
                filters.classList.add('scrolled');
            } else {
                filters.classList.remove('scrolled');
            }
            lastScroll = scrollY;
        }, { passive: true });
        
        loadDeals();
    </script>
</body>
</html>
